## 🧩 Dify 实战工作流库使用说明

> **目标人群：** 已经会基础 Dify 操作，但想直接复用“闲鱼同款高转化工作流”的同学（包括像 **陈木君** 这样在做知识库/垂直项目的进阶用户）。
>
> **你能收获：** 学会如何把本仓库里的 `.yml` 模板一键导入到自己的 Dify 环境，并通过 RAG 调优把效果拉满。

---

## 🗂 1. 工作流模板放在哪？

- 所有可直接导入的 Dify 工作流模板，统一放在：
  - `闲鱼dify工作流/可参考的dify工作流模板/`
- 文件格式：全部为 **YAML (`.yml`)**，可在 Dify 后台「导入应用 / 导入工作流」时直接使用。

你可以：

- 在 GitHub Web 端直接点击某个 `.yml` 文件 → `Download raw file` 保存到本地
- 或者本地 `git clone` 仓库后，直接在文件管理器中找到对应 `.yml` 文件

> **建议做法：** 先从 README 里的 **「⚙️ Dify 实战工作流库」表格** 选一个与你业务最接近的模板，跑通一个，再慢慢魔改。

---

## 🚀 2. 准备好你的 Dify 环境

### 2.1 云端版 Dify（官方托管）

1. 打开 Dify 官方网站并登录账号
2. 在左侧点击 **「应用」 → 「工作流」**
3. 确认你已经在「模型提供商」里配置好至少一个可用的大模型（如 DeepSeek、OpenAI、SiliconFlow 等）

### 2.2 自建版 Dify（本地 / 服务器）

1. 按官方文档完成部署（推荐 Docker Compose）  
   - 文档参考：`https://docs.dify.ai/`
2. 在浏览器访问你的 Dify 面板（如 `http://localhost:3000` / 内网地址）
3. 在「系统管理 → 模型提供商」中配置：
   - 一个通用对话模型（如 DeepSeek-R1 / GPT-4.x）
   - 可选：一个 Embedding 模型（用于知识库/RAG）
   - 可选：一个 Rerank 模型（用于重排序，进阶用户推荐配置）

> **小贴士：** 如果你用的是本地 DeepSeek（Ollama 等），记得在 Dify 里配置对应的 API 网关或中间层服务。

---

## 📥 3. 如何导入 `.yml` 工作流？

下面以「工作流应用」为例，演示通用导入步骤（云端版 & 自建版基本一致）：

### 步骤 1：下载模板文件

1. 在仓库中找到你想用的模板，例如：
   - `闲鱼dify工作流/可参考的dify工作流模板/发票提取小工具整合版-变量聚合器.yml`
2. 将该 `.yml` 文件下载到本地电脑（保持文件名不变即可）

### 步骤 2：在 Dify 中导入

1. 登录 Dify 控制台
2. 左侧点击 **「应用」 → 「工作流」**
3. 点击右上角 **「导入应用」** / **「Import」**（不同版本文案略有差异）：
   - 选择 **「从文件导入（YAML/JSON）」** 选项
   - 在弹出的对话框中上传刚才下载的 `.yml` 文件
4. 导入完成后，你会在「工作流列表」中看到一个新的应用，名称通常与 `.yml` 中定义的 `app.name` 一致

### 步骤 3：检查并配置必要参数

很多模板会预留变量或连接器，建议按下面顺序检查一遍：

1. 进入刚导入的工作流应用，点击 **「编辑」**
2. 重点检查：
   - **变量面板**：是否有必填变量（如 API Key、数据库连接串、知识库 ID 等）
   - **工具节点**：是否用到了 HTTP 请求、数据库、第三方服务（需要你填入真实地址/密钥）
   - **模型节点**：确认模型已经在「模型提供商」中配置好，并处于启用状态
3. 点击「保存」后，直接在右侧 **「对话/测试」** 面板中试跑一轮

> **实战建议：** 每次只修改一两处配置，然后立刻测试，尽量避免“一口气改完一堆东西，结果不知道哪一步改坏了”。

---

## 🧪 4. 推荐先体验哪些模板？

如果你时间有限，可以按下面顺序体验（从易到难）：

- **内容类：**
  - `小红书文案生成器.yml`
  - `SEO 文章生成专家.yml`
  - `YouTube博主和自媒体运营专家工作流.yml`
- **工具类：**
  - `SQL 生成器.yml`
  - `Python Coding Prompt.yml`
  - `大模型表格解析自动生成代码生成统计图.yml`
- **RAG / 知识库类：**
  - `知识库检索工作流.yml`
  - `解析网页内容存到知识库.yml`
  - `图文知识库.yml`
- **垂直行业类（适合做付费服务）：**
  - `发票提取小工具整合版-变量聚合器.yml`
  - `发票比对专家-新版客运火车票2.yml`
  - `门诊导诊.yml`
  - `合同审查.yml`

---

## 🧠 5. 如何提升 RAG 召回质量（Top-K & Rerank 实战）

> 这一段是给「已经在做知识库项目」的你准备的，稍微硬核一点，但对效果提升非常明显。

在 Dify 的 RAG 流程里，通常会经历三个关键步骤：

1. **召回（Retrieve）**：用向量/关键词检索，从知识库中取出前 K 条候选文档
2. **重排（Rerank，可选但强烈推荐）**：用更强的排序模型，对召回结果重新打分
3. **生成（Generate）**：把最终选中的文档片段拼接后喂给大模型，让它回答问题

下面是几个直接可抄的调优思路：

### 5.1 Top-K 怎么调更合适？

- **初始建议：**
  - 普通 FAQ / 文档类知识库：`Top-K = 4 ~ 8`
  - 法律/医疗/金融等细粒度场景：`Top-K = 8 ~ 12`
- **调参思路：**
  1. 先固定模型和 chunk 策略，只动 `Top-K`
  2. 准备一批典型问句（至少 20 条），人工打分“是否命中了正确文档”
  3. 逐步从 4 → 6 → 8 → 10 调整，记录每个 K 值下的“命中率”
  4. 发现继续增大 `Top-K` 命中率提升不明显，甚至答案变得啰嗦/跑题，就说明已经过大

> **经验结论：**  
> - `Top-K` 太小 → 容易漏掉关键段落  
> - `Top-K` 太大 → 模型上下文被“噪声”占满，反而更容易答偏  
> **原则：在“够用”的前提下，尽量小。**

### 5.2 什么时候一定要上 Rerank？

以下几种情况，**强烈推荐启用 Rerank 模型：**

- 单个知识库里内容很多、主题杂（比如混着产品文档 + 合同 + 培训 PPT）
- 用户问题比较长，且经常带上下文（例如“根据上面那份合同，帮我判断违约责任”）
- 你已经把向量模型换成比较强的（如 bge-m3、text-embedding-3-large），但答案仍然“不稳”

**推荐策略：**

- 检索阶段 `Top-K (retrieve)` 可以适当放大，例如：`K = 20`
- Rerank 阶段再选出前 `N = 5` 条高质量文档喂给大模型

在 Dify 里通常有两个关键参数：

- `retrieval_top_k`：向量检索时拉回多少条
- `rerank_top_n`：重排后最终保留多少条

> **实战示例：**
> - 先设定：`retrieval_top_k = 20`，`rerank_top_n = 5`
> - 如果你发现答案经常缺信息 → 适当把 `rerank_top_n` 提到 6~8  
> - 如果答案啰嗦且重复 → 先减小 `retrieval_top_k` 到 10~15

### 5.3 选什么 Rerank 模型更靠谱？

如果你面向中文 & 中英混合知识库，推荐优先考虑：

- **bge-reranker 系列**（如 `bge-reranker-v2-m3`）：对中文支持好，开源可自建
- **硅基流动 / 智谱 / 阿里等厂商的中文 Rerank API**：省心但有调用成本

选择时可以注意三点：

1. **语言匹配度**：主要是中文/英文/多语种？优先选为该语言优化过的模型
2. **延迟**：Rerank 本身也要算 Token，太慢会拖垮整体体验
3. **成本**：如果知识库调用非常频繁，可以考虑自建开源 Rerank 模型


跑一轮之后：

1. 先人工看 20~30 条问答，标记哪些是「完全符合预期」「勉强可接受」「答偏/答错」
2. 如果大部分“答偏”是因为 **没召回到正确文档** → 调整 chunk + `retrieval_top_k`
3. 如果“召回对了但回答乱说” → 优先调提示词 / 输出格式，再考虑换生成模型

---

## 🔗 6. 相关链接 & 下一步

- **README 总览：** [返回项目首页](./README.md)
- **工作流目录：** `闲鱼dify工作流/可参考的dify工作流模板/`
- **工作流索引：** 查看 README 中的 **「⚙️ Dify 实战工作流库」** 章节
- **变现实战：** 如果想把这些工作流卖给客户赚钱，可阅读 [《DeepSeek 变现实战指南》](./Monetization.md)

---

> **一句话总结：**  
> 不要从 0 写工作流，先把现成模板导入跑通，再按你自己的业务“微调 + 魔改”，这是最快见效、也最容易变现的一条路。加油💪

